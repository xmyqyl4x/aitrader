<!-- Page Title -->
<div class="app-page-title">
  <div class="page-title-wrapper">
    <div class="page-title-heading">
      <div>Stock Quote Review Stack</div>
      <div class="page-title-subheading">
        View and manage all stock quote searches and reviews.
      </div>
    </div>
    <div class="page-title-actions">
      <button routerLink="/stock-review" class="btn btn-primary">
        <i class="pe-7s-plus"></i> New Search
      </button>
    </div>
  </div>
</div>

<!-- Filters Card -->
<div class="row">
  <div class="col-md-12">
    <div class="main-card mb-3 card">
      <div class="card-header">
        <i class="header-icon pe-7s-filter"></i>
        Filters
      </div>
      <div class="card-body">
        <form [formGroup]="filterForm" (ngSubmit)="onFilter()">
          <div class="row">
            <div class="col-md-4">
              <div class="position-relative form-group">
                <label for="symbolFilter">Symbol</label>
                <input
                  type="text"
                  id="symbolFilter"
                  formControlName="symbol"
                  class="form-control"
                  placeholder="Filter by symbol..."
                />
              </div>
            </div>
            <div class="col-md-4">
              <div class="position-relative form-group">
                <label for="statusFilter">Status</label>
                <select id="statusFilter" formControlName="status" class="form-control">
                  <option value="">All</option>
                  <option value="SUCCESS">Success</option>
                  <option value="FAILED">Failed</option>
                </select>
              </div>
            </div>
            <div class="col-md-4">
              <div class="position-relative form-group">
                <label>&nbsp;</label>
                <div class="d-flex gap-2">
                  <button type="submit" class="btn btn-primary">
                    <i class="pe-7s-search"></i> Filter
                  </button>
                  <button type="button" (click)="filterForm.reset(); onFilter()" class="btn btn-secondary">
                    <i class="pe-7s-close-circle"></i> Clear
                  </button>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Error Message -->
<div *ngIf="error" class="row">
  <div class="col-md-12">
    <div class="alert alert-danger" role="alert">
      <i class="pe-7s-close-circle"></i> {{ error }}
    </div>
  </div>
</div>

<!-- Loading State -->
<div *ngIf="loading" class="row">
  <div class="col-md-12">
    <div class="main-card mb-3 card">
      <div class="card-body text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading searches...</p>
      </div>
    </div>
  </div>
</div>

<!-- Searches Table -->
<div *ngIf="!loading && searches.length > 0" class="row">
  <div class="col-md-12">
    <div class="main-card mb-3 card">
      <div class="card-header">
        <i class="header-icon pe-7s-graph"></i>
        Search History
        <span class="badge bg-primary ms-2">{{ totalElements }}</span>
      </div>
      <div class="table-responsive">
        <table class="mb-0 table table-hover">
          <thead>
            <tr>
              <th>Symbol</th>
              <th>Company Name</th>
              <th>Range</th>
              <th>Searched At</th>
              <th>Status</th>
              <th>Price</th>
              <th>Change</th>
              <th>Volume</th>
              <th>Provider</th>
              <th>Review</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let search of searches">
              <td><strong>{{ search.symbol }}</strong></td>
              <td>{{ search.companyName || '-' }}</td>
              <td>
                <span class="badge bg-secondary">{{ search.range }}</span>
              </td>
              <td>{{ search.createdAt | date:'short' }}</td>
              <td>
                <span class="badge" [ngClass]="search.status === 'SUCCESS' ? 'bg-success' : 'bg-danger'">
                  {{ search.status }}
                </span>
              </td>
              <td>
                <span *ngIf="search.price" class="fw-bold">${{ search.price | number:'1.2-2' }}</span>
                <span *ngIf="!search.price" class="text-muted">-</span>
              </td>
              <td>
                <span *ngIf="search.changeAmount && search.changePercent">
                  <span [ngClass]="search.changeAmount >= 0 ? 'text-success' : 'text-danger'" class="fw-bold">
                    {{ search.changeAmount >= 0 ? '+' : '' }}{{ search.changeAmount | number:'1.2-2' }}
                    ({{ search.changePercent >= 0 ? '+' : '' }}{{ search.changePercent | number:'1.2-2' }}%)
                  </span>
                </span>
                <span *ngIf="!search.changeAmount" class="text-muted">-</span>
              </td>
              <td>{{ search.volume | number }}</td>
              <td>
                <span class="badge bg-info">{{ search.provider }}</span>
              </td>
              <td>
                <span class="badge" [ngClass]="search.reviewStatus === 'REVIEWED' ? 'bg-primary' : 'bg-secondary'">
                  {{ search.reviewStatus }}
                </span>
              </td>
              <td>
                <div class="btn-group" role="group">
                  <button (click)="onView(search)" class="btn btn-sm btn-outline-secondary" title="View">
                    <i class="pe-7s-look"></i>
                  </button>
                  <button (click)="onRerun(search)" class="btn btn-sm btn-outline-primary" title="Re-run">
                    <i class="pe-7s-refresh"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="card-footer" *ngIf="totalPages > 1">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <small class="text-muted">
              Showing {{ (page * size) + 1 }} - {{ Math.min((page + 1) * size, totalElements) }} of {{ totalElements }} results
            </small>
          </div>
          <nav>
            <ul class="pagination mb-0">
              <li class="page-item" [class.disabled]="page === 0">
                <a class="page-link" (click)="onPageChange(page - 1)" [class.pointer]="page > 0" [attr.tabindex]="page === 0 ? -1 : 0">
                  Previous
                </a>
              </li>
              <li class="page-item disabled">
                <span class="page-link">Page {{ page + 1 }} of {{ totalPages }}</span>
              </li>
              <li class="page-item" [class.disabled]="page >= totalPages - 1">
                <a class="page-link" (click)="onPageChange(page + 1)" [class.pointer]="page < totalPages - 1" [attr.tabindex]="page >= totalPages - 1 ? -1 : 0">
                  Next
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Empty State -->
<div *ngIf="!loading && searches.length === 0" class="row">
  <div class="col-md-12">
    <div class="main-card mb-3 card">
      <div class="card-body text-center py-5">
        <i class="pe-7s-graph" style="font-size: 64px; color: #ccc;"></i>
        <h5 class="mt-3 text-muted">No Searches Found</h5>
        <p class="text-muted">
          No searches found. <a routerLink="/stock-review" class="text-primary">Create a new search</a> to get started.
        </p>
      </div>
    </div>
  </div>
</div>

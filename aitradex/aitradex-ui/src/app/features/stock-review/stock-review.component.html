<!-- Page Title -->
<div class="page-title">
  <h1>Stock Quote Dashboard</h1>
  <p>Real-time stock quotes, price charts, and portfolio analysis.</p>
</div>

<!-- Search Form Card -->
<div class="row">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header">
        <i class="fa fa-search me-2"></i>
        Search for Stock Quote
      </div>
      <div class="card-body">
        <form [formGroup]="searchForm" (ngSubmit)="onSearch()">
          <div class="row">
            <div class="col-md-4">
              <div class="position-relative form-group">
                <label for="symbol">Symbol <span class="text-danger">*</span></label>
                <input
                  type="text"
                  id="symbol"
                  [attr.data-testid]="'symbol-input'"
                  formControlName="symbol"
                  class="form-control"
                  placeholder="e.g., AAPL"
                  [class.is-invalid]="searchForm.get('symbol')?.invalid && searchForm.get('symbol')?.touched"
                  maxlength="10"
                />
                <div class="invalid-feedback" *ngIf="searchForm.get('symbol')?.invalid && searchForm.get('symbol')?.touched">
                  Symbol is required (letters only, max 10 characters)
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="position-relative form-group">
                <label for="range">Time Range <span class="text-danger">*</span></label>
                <select id="range" [attr.data-testid]="'range-select'" formControlName="range" class="form-control">
                  <option value="1D">1 Day</option>
                  <option value="5D">5 Days</option>
                  <option value="1M">1 Month</option>
                  <option value="3M">3 Months</option>
                  <option value="1Y">1 Year</option>
                </select>
              </div>
            </div>
            <div class="col-md-3">
              <div class="position-relative form-group">
                <label for="exchange">Exchange (Optional)</label>
                <input
                  type="text"
                  id="exchange"
                  [attr.data-testid]="'exchange-input'"
                  formControlName="exchange"
                  class="form-control"
                  placeholder="e.g., NASDAQ"
                />
              </div>
            </div>
            <div class="col-md-2">
              <div class="position-relative form-group">
                <label>&nbsp;</label>
                <button
                  type="submit"
                  [attr.data-testid]="'search-button'"
                  [disabled]="searchForm.invalid || loading"
                  class="btn btn-primary btn-block"
                >
                  <span *ngIf="loading" data-testid="loading-indicator">
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    Loading...
                  </span>
                  <span *ngIf="!loading">Fetch Quote</span>
                </button>
              </div>
            </div>
          </div>
        </form>

        <!-- Alert Messages -->
        <div *ngIf="error" [attr.data-testid]="'error-alert'" class="alert alert-danger mt-3" role="alert">
          <i class="fa fa-exclamation-circle me-2"></i> {{ error }}
        </div>
        <div *ngIf="successMessage" [attr.data-testid]="'success-alert'" class="alert alert-success mt-3" role="alert">
          <i class="fa fa-check-circle me-2"></i> {{ successMessage }}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quote Display Dashboard -->
<div *ngIf="quote && !loading" [attr.data-testid]="'quote-dashboard'" class="row">
  <!-- Quote Header and Key Metrics -->
  <div class="col-md-12">
    <div class="main-card mb-3 card">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h5 class="mb-0">{{ quote.symbol }}</h5>
            <small class="text-muted">{{ quote.companyName || 'N/A' }}</small>
          </div>
          <div>
            <span class="badge bg-secondary">{{ quote.source }}</span>
            <span class="badge ms-2" [ngClass]="getChangeClass() === 'positive' ? 'bg-success' : 'bg-danger'">
              <span *ngIf="quote.open && quote.close">
                {{ getChangePercent() !== null ? (getChangePercent()! >= 0 ? '+' : '') + (getChangePercent()! | number:'1.2-2') + '%' : 'N/A' }}
              </span>
            </span>
          </div>
        </div>
      </div>
      <div class="card-body">
        <!-- Key Metrics Row -->
        <div class="row g-3">
          <div class="col-md-4 col-lg-3">
            <div class="card" [ngClass]="getChangeClass() === 'positive' ? 'bg-success' : getChangeClass() === 'negative' ? 'bg-danger' : 'bg-info'">
              <div class="card-body text-white">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <div class="small">Last Price</div>
                    <div class="h5 mb-0">${{ quote.close | number:'1.2-2' }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-4 col-lg-3">
            <div class="card bg-info">
              <div class="card-body text-white">
                <div class="small">Change</div>
                <div class="h5 mb-0">
                  <span *ngIf="quote.open && quote.close">
                    ${{ (quote.close - quote.open) | number:'1.2-2' }}
                  </span>
                  <span *ngIf="!quote.open || !quote.close">N/A</span>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-4 col-lg-3">
            <div class="card bg-warning">
              <div class="card-body text-white">
                <div class="small">Day Range</div>
                <div class="h6 mb-0">
                  <span *ngIf="quote.low && quote.high">
                    ${{ quote.low | number:'1.2-2' }} - ${{ quote.high | number:'1.2-2' }}
                  </span>
                  <span *ngIf="!quote.low || !quote.high">N/A</span>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-4 col-lg-3">
            <div class="card bg-primary">
              <div class="card-body text-white">
                <div class="small">Volume</div>
                <div class="h6 mb-0">{{ quote.volume | number }}</div>
              </div>
            </div>
          </div>

          <div class="col-md-4 col-lg-3">
            <div class="card bg-dark">
              <div class="card-body text-white">
                <div class="small">Open</div>
                <div class="h6 mb-0">${{ quote.open | number:'1.2-2' }}</div>
              </div>
            </div>
          </div>

          <div class="col-md-4 col-lg-3">
            <div class="card bg-secondary">
              <div class="card-body text-white">
                <div class="small">Updated</div>
                <div class="small">{{ quote.asOf | date:'short' }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Price Chart Dashboard Card -->
  <div class="col-md-12">
    <div class="card">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <i class="fa fa-chart-line me-2"></i>
            Price Chart - {{ quote.symbol }}
          </div>
        </div>
      </div>
      <div class="card-body">
        <!-- Chart Type Selector -->
        <div class="chart-type-selector mb-3 pb-3 border-bottom">
          <label class="me-3 mb-0 fw-bold">Chart Type:</label>
          <div class="btn-group btn-group-toggle" role="group" aria-label="Chart type selector" data-toggle="buttons">
            <button
              *ngFor="let type of availableChartTypes"
              type="button"
              [attr.data-testid]="'chart-type-' + type.value"
              class="btn"
              [ngClass]="chartType === type.value ? 'btn-primary active' : 'btn-outline-secondary'"
              (click)="setChartType(type.value)"
              [title]="type.label"
            >
              <i *ngIf="type.icon" [class]="type.icon + ' me-1'"></i>
              <span>{{ type.label }}</span>
            </button>
          </div>
        </div>
        <app-stock-chart
          *ngIf="history && history.length > 0"
          [data]="history"
          [symbol]="quote.symbol"
          [chartType]="chartType"
        ></app-stock-chart>
        <div *ngIf="!history || history.length === 0" class="text-center py-5 text-muted">
          <i class="fa fa-chart-line" style="font-size: 48px;"></i>
          <p class="mt-3">No chart data available for this range.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Additional Details Row -->
  <div class="col-md-12">
    <div class="row">
      <div class="col-md-4">
        <div class="card mb-3">
          <div class="card-header">
            <i class="fa fa-arrow-up text-success me-2"></i> High
          </div>
          <div class="card-body">
            <h5 class="card-title text-success mb-0">${{ quote.high | number:'1.2-2' }}</h5>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card mb-3">
          <div class="card-header">
            <i class="fa fa-arrow-down text-danger me-2"></i> Low
          </div>
          <div class="card-body">
            <h5 class="card-title text-danger mb-0">${{ quote.low | number:'1.2-2' }}</h5>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card mb-3">
          <div class="card-header">
            <i class="fa fa-dollar-sign me-2"></i> Currency
          </div>
          <div class="card-body">
            <h5 class="card-title mb-0">{{ quote.currency || 'USD' }}</h5>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Review Panel -->
  <div class="col-md-12">
    <div class="card">
      <div class="card-header">
        <i class="fa fa-edit me-2"></i>
        Review & Notes
      </div>
      <div class="card-body">
        <form>
          <div class="row">
            <div class="col-md-12">
              <div class="position-relative form-group">
                <label for="reviewStatus">Review Status</label>
                <select
                  id="reviewStatus"
                  class="form-control"
                  [(ngModel)]="review.reviewStatus"
                  [ngModelOptions]="{standalone: true}"
                >
                  <option value="NOT_REVIEWED">Not Reviewed</option>
                  <option value="REVIEWED">Reviewed</option>
                </select>
              </div>
            </div>
            <div class="col-md-12">
              <div class="position-relative form-group">
                <label for="reviewNote">Notes</label>
                <textarea
                  id="reviewNote"
                  class="form-control"
                  [(ngModel)]="review.reviewNote"
                  [ngModelOptions]="{standalone: true}"
                  placeholder="Add your review notes here..."
                  rows="4"
                ></textarea>
              </div>
            </div>
            <div class="col-md-12">
              <button
                type="button"
                (click)="onSaveReview()"
                [disabled]="!searchId"
                class="btn btn-primary"
              >
                <i class="fa fa-save me-2"></i> Save Review
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- No Data State -->
<div *ngIf="!quote && !loading && !error" class="row">
  <div class="col-md-12">
    <div class="card">
      <div class="card-body text-center py-5">
        <i class="fa fa-chart-line" style="font-size: 64px; color: #ccc;"></i>
        <h5 class="mt-3 text-muted">No Quote Data</h5>
        <p class="text-muted">Enter a stock symbol above to view quote information and interactive charts.</p>
      </div>
    </div>
  </div>
</div>

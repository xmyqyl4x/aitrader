<!-- Page Title -->
<div class="app-page-title">
  <div class="page-title-wrapper">
    <div class="page-title-heading">
      <div>Stock Quote Dashboard</div>
      <div class="page-title-subheading">
        Real-time stock quotes, price charts, and portfolio analysis.
      </div>
    </div>
  </div>
</div>

<!-- Search Form Card -->
<div class="row">
  <div class="col-md-12">
    <div class="main-card mb-3 card">
      <div class="card-header">
        <i class="header-icon pe-7s-search"></i>
        Search for Stock Quote
      </div>
      <div class="card-body">
        <form [formGroup]="searchForm" (ngSubmit)="onSearch()">
          <div class="row">
            <div class="col-md-4">
              <div class="position-relative form-group">
                <label for="symbol">Symbol <span class="text-danger">*</span></label>
                <input
                  type="text"
                  id="symbol"
                  formControlName="symbol"
                  class="form-control"
                  placeholder="e.g., AAPL"
                  [class.is-invalid]="searchForm.get('symbol')?.invalid && searchForm.get('symbol')?.touched"
                  maxlength="10"
                />
                <div class="invalid-feedback" *ngIf="searchForm.get('symbol')?.invalid && searchForm.get('symbol')?.touched">
                  Symbol is required (letters only, max 10 characters)
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="position-relative form-group">
                <label for="range">Time Range <span class="text-danger">*</span></label>
                <select id="range" formControlName="range" class="form-control">
                  <option value="1D">1 Day</option>
                  <option value="5D">5 Days</option>
                  <option value="1M">1 Month</option>
                  <option value="3M">3 Months</option>
                  <option value="1Y">1 Year</option>
                </select>
              </div>
            </div>
            <div class="col-md-3">
              <div class="position-relative form-group">
                <label for="exchange">Exchange (Optional)</label>
                <input
                  type="text"
                  id="exchange"
                  formControlName="exchange"
                  class="form-control"
                  placeholder="e.g., NASDAQ"
                />
              </div>
            </div>
            <div class="col-md-2">
              <div class="position-relative form-group">
                <label>&nbsp;</label>
                <button
                  type="submit"
                  [disabled]="searchForm.invalid || loading"
                  class="btn btn-primary btn-block"
                >
                  <span *ngIf="loading">
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    Loading...
                  </span>
                  <span *ngIf="!loading">Fetch Quote</span>
                </button>
              </div>
            </div>
          </div>
        </form>

        <!-- Alert Messages -->
        <div *ngIf="error" class="alert alert-danger mt-3" role="alert">
          <i class="pe-7s-close-circle"></i> {{ error }}
        </div>
        <div *ngIf="successMessage" class="alert alert-success mt-3" role="alert">
          <i class="pe-7s-check"></i> {{ successMessage }}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quote Display Dashboard -->
<div *ngIf="quote && !loading" class="row">
  <!-- Quote Header and Key Metrics -->
  <div class="col-md-12">
    <div class="main-card mb-3 card">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h5 class="mb-0">{{ quote.symbol }}</h5>
            <small class="text-muted">{{ quote.companyName || 'N/A' }}</small>
          </div>
          <div>
            <span class="badge bg-secondary">{{ quote.source }}</span>
            <span class="badge ms-2" [ngClass]="getChangeClass() === 'positive' ? 'bg-success' : 'bg-danger'">
              <span *ngIf="quote.open && quote.close">
                {{ getChangePercent() !== null ? (getChangePercent()! >= 0 ? '+' : '') + (getChangePercent()! | number:'1.2-2') + '%' : 'N/A' }}
              </span>
            </span>
          </div>
        </div>
      </div>
      <div class="card-body">
        <!-- Key Metrics Row -->
        <div class="row">
          <div class="col-md-3 col-lg-2">
            <div class="card mb-3 widget-content" [ngClass]="getChangeClass() === 'positive' ? 'bg-success' : getChangeClass() === 'negative' ? 'bg-danger' : 'bg-info'">
              <div class="widget-content-wrapper text-white">
                <div class="widget-content-left">
                  <div class="widget-heading">Last Price</div>
                  <div class="widget-subheading">Current</div>
                </div>
                <div class="widget-content-right">
                  <div class="widget-numbers text-white">
                    <span>${{ quote.close | number:'1.2-2' }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-3 col-lg-2">
            <div class="card mb-3 widget-content bg-info">
              <div class="widget-content-wrapper text-white">
                <div class="widget-content-left">
                  <div class="widget-heading">Change</div>
                  <div class="widget-subheading">Today</div>
                </div>
                <div class="widget-content-right">
                  <div class="widget-numbers text-white">
                    <span *ngIf="quote.open && quote.close">
                      ${{ (quote.close - quote.open) | number:'1.2-2' }}
                    </span>
                    <span *ngIf="!quote.open || !quote.close">N/A</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-3 col-lg-2">
            <div class="card mb-3 widget-content bg-warning">
              <div class="widget-content-wrapper text-white">
                <div class="widget-content-left">
                  <div class="widget-heading">Day Range</div>
                  <div class="widget-subheading">High - Low</div>
                </div>
                <div class="widget-content-right">
                  <div class="widget-numbers text-white">
                    <small *ngIf="quote.low && quote.high">
                      ${{ quote.low | number:'1.2-2' }} - ${{ quote.high | number:'1.2-2' }}
                    </small>
                    <small *ngIf="!quote.low || !quote.high">N/A</small>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-3 col-lg-2">
            <div class="card mb-3 widget-content bg-primary">
              <div class="widget-content-wrapper text-white">
                <div class="widget-content-left">
                  <div class="widget-heading">Volume</div>
                  <div class="widget-subheading">Shares</div>
                </div>
                <div class="widget-content-right">
                  <div class="widget-numbers text-white">
                    <span>{{ quote.volume | number }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-3 col-lg-2">
            <div class="card mb-3 widget-content bg-dark">
              <div class="widget-content-wrapper text-white">
                <div class="widget-content-left">
                  <div class="widget-heading">Open</div>
                  <div class="widget-subheading">Opening</div>
                </div>
                <div class="widget-content-right">
                  <div class="widget-numbers text-white">
                    <span>${{ quote.open | number:'1.2-2' }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-3 col-lg-2">
            <div class="card mb-3 widget-content bg-secondary">
              <div class="widget-content-wrapper text-white">
                <div class="widget-content-left">
                  <div class="widget-heading">Updated</div>
                  <div class="widget-subheading">Last Update</div>
                </div>
                <div class="widget-content-right">
                  <div class="widget-numbers text-white">
                    <small>{{ quote.asOf | date:'short' }}</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Price Chart Dashboard Card -->
  <div class="col-md-12">
    <div class="main-card mb-3 card">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <i class="header-icon pe-7s-graph1"></i>
            Price Chart - {{ quote.symbol }}
          </div>
        </div>
      </div>
      <div class="card-body">
        <!-- Chart Type Selector -->
        <div class="chart-type-selector mb-3 pb-3 border-bottom">
          <label class="me-3 mb-0 fw-bold">Chart Type:</label>
          <div class="btn-group btn-group-toggle" role="group" aria-label="Chart type selector" data-toggle="buttons">
            <button
              *ngFor="let type of availableChartTypes"
              type="button"
              class="btn"
              [ngClass]="chartType === type.value ? 'btn-primary active' : 'btn-outline-secondary'"
              (click)="setChartType(type.value)"
              [title]="type.label"
            >
              <span *ngIf="type.icon" [class]="type.icon + ' me-1'"></span>
              <span>{{ type.label }}</span>
            </button>
          </div>
        </div>
        <app-stock-chart
          *ngIf="history && history.length > 0"
          [data]="history"
          [symbol]="quote.symbol"
          [chartType]="chartType"
        ></app-stock-chart>
        <div *ngIf="!history || history.length === 0" class="text-center py-5 text-muted">
          <i class="pe-7s-graph1" style="font-size: 48px;"></i>
          <p class="mt-3">No chart data available for this range.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Additional Details Row -->
  <div class="col-md-12">
    <div class="row">
      <div class="col-md-4">
        <div class="card-hover-shadow-2x mb-3 card">
          <div class="card-header">
            <i class="pe-7s-graph2"></i> High
          </div>
          <div class="card-body">
            <h5 class="card-title text-success mb-0">${{ quote.high | number:'1.2-2' }}</h5>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card-hover-shadow-2x mb-3 card">
          <div class="card-header">
            <i class="pe-7s-graph3"></i> Low
          </div>
          <div class="card-body">
            <h5 class="card-title text-danger mb-0">${{ quote.low | number:'1.2-2' }}</h5>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card-hover-shadow-2x mb-3 card">
          <div class="card-header">
            <i class="pe-7s-global"></i> Currency
          </div>
          <div class="card-body">
            <h5 class="card-title mb-0">{{ quote.currency || 'USD' }}</h5>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Review Panel -->
  <div class="col-md-12">
    <div class="main-card mb-3 card">
      <div class="card-header">
        <i class="header-icon pe-7s-note2"></i>
        Review & Notes
      </div>
      <div class="card-body">
        <form>
          <div class="row">
            <div class="col-md-12">
              <div class="position-relative form-group">
                <label for="reviewStatus">Review Status</label>
                <select
                  id="reviewStatus"
                  class="form-control"
                  [(ngModel)]="review.reviewStatus"
                  [ngModelOptions]="{standalone: true}"
                >
                  <option value="NOT_REVIEWED">Not Reviewed</option>
                  <option value="REVIEWED">Reviewed</option>
                </select>
              </div>
            </div>
            <div class="col-md-12">
              <div class="position-relative form-group">
                <label for="reviewNote">Notes</label>
                <textarea
                  id="reviewNote"
                  class="form-control"
                  [(ngModel)]="review.reviewNote"
                  [ngModelOptions]="{standalone: true}"
                  placeholder="Add your review notes here..."
                  rows="4"
                ></textarea>
              </div>
            </div>
            <div class="col-md-12">
              <button
                type="button"
                (click)="onSaveReview()"
                [disabled]="!searchId"
                class="btn btn-primary"
              >
                <i class="pe-7s-diskette"></i> Save Review
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- No Data State -->
<div *ngIf="!quote && !loading && !error" class="row">
  <div class="col-md-12">
    <div class="main-card mb-3 card">
      <div class="card-body text-center py-5">
        <i class="pe-7s-graph1" style="font-size: 64px; color: #ccc;"></i>
        <h5 class="mt-3 text-muted">No Quote Data</h5>
        <p class="text-muted">Enter a stock symbol above to view quote information and interactive charts.</p>
      </div>
    </div>
  </div>
</div>

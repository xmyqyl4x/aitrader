databaseChangeLog:
  - changeSet:
      id: 0005-etrade-oauth-tracking
      author: aitradex
      context: dev,test,prod
      logicalFilePath: db/changelog/changesets/0005-etrade-oauth-tracking.yaml
      changes:
        # Add missing fields to etrade_oauth_token table for tracking all authorization attempts
        - addColumn:
            tableName: etrade_oauth_token
            columns:
              # Track authorization attempt timing
              - column:
                  name: start_time
                  type: timestamptz
                  remarks: "Time when authorization attempt started (request token step)"
              
              - column:
                  name: end_time
                  type: timestamptz
                  remarks: "Time when authorization attempt completed (success or failure)"
              
              # Track authorization attempt status
              - column:
                  name: status
                  type: varchar(50)
                  defaultValue: "PENDING"
                  remarks: "Status of authorization attempt: PENDING, SUCCESS, FAILED"
              
              # Track verification code (oauth_verifier) - already exists but ensuring clarity
              # oauth_verifier column already exists
              
              # Track access token expiry
              # expires_at column already exists
              
              # Track error information for failed attempts
              - column:
                  name: error_message
                  type: text
                  remarks: "Error message if authorization attempt failed"
              
              - column:
                  name: error_code
                  type: varchar(100)
                  remarks: "Error code if authorization attempt failed"
              
              # Track environment and correlation
              - column:
                  name: environment
                  type: varchar(50)
                  remarks: "Environment where authorization was attempted: SANDBOX, PRODUCTION"
              
              - column:
                  name: correlation_id
                  type: varchar(255)
                  remarks: "Correlation ID for tracking authorization request across services"
              
              # Track user ID for the authorization attempt
              - column:
                  name: user_id
                  type: uuid
                  remarks: "User ID who initiated the authorization attempt"
        
        # Update account_id to allow null initially (set after successful authorization)
        - sql:
            sql: ALTER TABLE etrade_oauth_token ALTER COLUMN account_id DROP NOT NULL
        
        # Update access_token_encrypted to allow null (set only on successful authorization)
        - sql:
            sql: ALTER TABLE etrade_oauth_token ALTER COLUMN access_token_encrypted DROP NOT NULL
        
        # Update access_token_secret_encrypted to allow null (set only on successful authorization)
        - sql:
            sql: ALTER TABLE etrade_oauth_token ALTER COLUMN access_token_secret_encrypted DROP NOT NULL

        # Create index for querying by status and time
        - createIndex:
            tableName: etrade_oauth_token
            indexName: idx_etrade_oauth_token_status
            columns:
              - column:
                  name: status
          
        - createIndex:
            tableName: etrade_oauth_token
            indexName: idx_etrade_oauth_token_start_time
            columns:
              - column:
                  name: start_time
                  descending: true
          
        - createIndex:
            tableName: etrade_oauth_token
            indexName: idx_etrade_oauth_token_user_id
            columns:
              - column:
                  name: user_id
          
        - createIndex:
            tableName: etrade_oauth_token
            indexName: idx_etrade_oauth_token_correlation_id
            columns:
              - column:
                  name: correlation_id
